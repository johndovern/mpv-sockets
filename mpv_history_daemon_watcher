#!/bin/bash -ux
# For whatever reason, my mpv daemon stops working after running
# continiously for a few days. This restarts it every so often
# when its not being used for anything
# See https://github.com/seanbreckenridge/mpv-sockets/blob/master/DAEMON.md
# for more info on the daemon
#
# Pass the data directory for the mpv daemon as the first argument to
# this script, else it defaults to ~/data/mpv

DAEMON_PID=''

DATA_DIR="${1:-"${HOME}/data/mpv"}"

start_daemon() {
	set -e
	mpv-history-daemon /tmp/mpvsockets/ "${DATA_DIR}" &
	DAEMON_PID=$!
	set +e
}

mpv_active() {
	pgrep -x mpv
}

attempt_restart() {
	if mpv_active; then
		echo "Found active mpv instance, ignoring..."
	else
		echo "No mpv instances active, waiting..."
		sleep 5
		mpv_active || {
			echo "Restarting mpv daemon..."
			kill "${DAEMON_PID}"
			start_daemon
		}
	fi
}

cleanup() {
	echo "Killing background process..."
	kill "${DAEMON_PID}"
}

trap cleanup EXIT

start_daemon
while true; do
	sleep 3h
	attempt_restart
done
