#!/bin/bash
# mpv-get-property wrapper that gets full path of currently playing song
# If there are multiple sockets, presents you with fzf to pick one
# Can also provide an alternate command as a sink, like:
# mpv-currently-playing cat

declare -a full_paths
full_paths=()
for socket in $(mpv-active-sockets); do
  if SONG_PATH="$(mpv-get-property "$socket" 'path')" 2>/dev/null; then
    # if this is a full path
    [[ -n "$SONG_PATH" && -e "$SONG_PATH" ]] || {
      SONG_PATH="$(mpv-get-property "$socket" 'working-directory')/${SONG_PATH}"
    }
    if [[ -e "$SONG_PATH" ]]; then
      full_paths+=("$SONG_PATH")
    else
      echo "Error: ${SONG_PATH} doesn't exist" >&2
    fi
  fi
done

# switch on length of array (number of paths found)
case "${#full_paths[@]}" in
  0)
    exit 1
    ;;
  1)
    echo "${full_paths[0]}"
    ;;
  *)
    ( IFS=$'\n'; echo "${full_paths[*]}" ) | "${1:-fzf}" || exit $?
esac

